<!DOCTYPE html>
<html>
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
   <title>Azure Functions - Cognitive Services Demo</title>
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"> 
   <style>
       #canvasWrapper {
           z-index: 500;
       }

       #faceWrapper {
           z-index: 999;
       }
   </style>
</head>
<body>
    <header>
        <div class="collapse bg-dark" id="navbarHeader">
            <div class="container">
                <div class="row">
                    <div class="col-sm-8 col-md-7 py-4">
                        <h4 class="text-white">About</h4>
                        <p class="text-muted">
                            The purpose for this demo is to highlight the capabilities of both Azure Functions and Azure Cognitive Services. 
                            Additional services will be included within the architecture for purposes such as Security and usability. These will be things such 
                            as SignalR service and Azure Key vault
                        </p>
                    </div>
                    <div class="col-sm-4 offset-md-1 py-4">
                        <h4 class="text-white">Contact</h4>
                        <ul class="list-unstyled">
                            <li class="text-white">Jim Paine</li>
                            <li class="text-white">Azure App Dev Specialist @ Microsoft</li>
                            <li><a class="text-white" href="#">Follow on Twitter</a></li>
                            <li><a class="text-white" href="#">View on GitHub</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="navbar navbar-dark bg-dark shadow-sm">
            <div class="container d-flex justify-content-between">
                <a class="navbar-brand d-flex align-items-center" href="#">              
                    <strong>Jim.Cloud</strong>
                </a>
                <button class="navbar-toggler" aria-expanded="false" aria-controls="navbarHeader" aria-label="Toggle navigation" type="button" data-toggle="collapse" data-target="#navbarHeader">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
        </div>
    </header>
    <main role="main">

        <section class="jumbotron text-center">
            <div class="container">
                <h1 class="jumbotron-heading">Azure Functions - Cognitive Services Demo</h1>
                <p class="lead text-muted">The following demos are built with nothing more than Azure Functions and Azure Cognitive Services.</p>
            </div>
        </section>
    
        <div class="album py-5 bg-light">
            <div class="container">    
                <div class="row">                  
                    <div class="col-md-12">
                        <div class="card mb-12 shadow-sm">    
                            <div id="videoWrapper">
                                <video id="video" width="100%" autoplay="true" muted="muted"></video>                                    
                            </div>   
                            
                            <div id="canvasWrapper">
                                <canvas id="canvas"></canvas>
                            </div>

                            <div id="faceWrapper">
                                <canvas id="faceCanvas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>              
            </div> 
        </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
           

    <script>
        var canvas = document.getElementById('canvas');
        var faceCanvas = document.getElementById('faceCanvas');
        var context = canvas.getContext('2d');
        var video = document.getElementById('video'); 
        var videoWrapper = document.getElementById('videoWrapper');             
        var canvasWrapper = document.getElementById('canvasWrapper');           
        var faceWrapper = document.getElementById('faceWrapper'); 
                
        function size(){
            canvas.width = video.clientWidth;
            canvas.height = video.clientHeight;                
            canvas.style.width = videoWrapper.clientWidth;
            canvas.style.height = videoWrapper.clientHeight;
            canvasWrapper.style.marginTop = videoWrapper.clientHeight * -1 + "px";

            faceCanvas.width = video.clientWidth;
            faceCanvas.height = video.clientHeight;                
            faceCanvas.style.width = videoWrapper.clientWidth;
            faceCanvas.style.height = videoWrapper.clientHeight;
            faceWrapper.style.marginTop = videoWrapper.clientHeight * -1 + "px";
        }            

        window.addEventListener('resize', function(){ 
            size();
        });      


        video.addEventListener('play', function () {
            var $this = this; //cache
            (function loop() {
                if (!$this.paused && !$this.ended) {
                    context.drawImage($this, 0, 0, video.clientWidth, video.clientHeight);
                    var x = canvas.toDataURL("image/png"); 
                    processImage(x);
                    setTimeout(loop, 1000 / 30); // drawing at 30fps
                }
            })();
        }, 0);

        var constraints = { video: { width: videoWrapper.clientWidth, height: videoWrapper.clientHeight } };
            if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
                    video.srcObject = stream;                
                    video.play();   
                    size();             
                });                
            }
        

        function processImage(x)
        {
            $.ajax({
                url: "https://emotionchecker11778.azurewebsites.net/api/EmotionChecker",
                type: "POST",
                data: x,
                contentType: "application/octet-stream",

                success: function (response) {
                    var ctx = faceCanvas.getContext('2d');
                    ctx.clearRect(0, 0, faceCanvas.width, faceCanvas.height);
                    for (i = 0; i < response.length; i++){
                        ctx.beginPath();
                        ctx.rect(face.faceRectangle.top, face.faceRectangle.left, face.faceRectangle.width, face.faceRectangle.height);
                        ctx.lineWidth = 7;
                        ctx.strokeStyle = 'black';
                        ctx.stroke();
                    }                          
                },
                error: function (xhr, status, error) {
                    console.log(error);
                }
            });
        }
   </script>
</body>
</html>